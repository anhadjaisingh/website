---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { formatDate } from "../../lib/utils";

const posts = (await getCollection("blog"))
  .filter((post) => import.meta.env.DEV || !post.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const twoYearsAgo = new Date();
twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);

const recentPosts = posts.filter((post) => post.data.date >= twoYearsAgo);
const archivePosts = posts.filter((post) => post.data.date < twoYearsAgo);
---

<BaseLayout title="Blog">
  <h1 class="font-serif text-4xl font-bold mb-8">Blog</h1>
  <ul class="divide-y divide-stone-200 dark:divide-stone-700">
    {
      recentPosts.map((post) => (
        <li class="py-6 first:pt-0">
          <a href={`/blog/${post.id}`} class="group block">
            <h2 class="text-xl font-semibold group-hover:text-accent transition-colors">
              {post.data.title}
              {post.data.draft && (
                <span class="ml-2 align-middle text-xs font-medium px-1.5 py-0.5 rounded bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200">
                  Draft
                </span>
              )}
            </h2>
            <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-stone-500 mt-1">
              <time datetime={post.data.date.toISOString()}>
                {formatDate(post.data.date)}
              </time>
              {post.data.tags.length > 0 && (
                <div class="flex gap-2">
                  {post.data.tags.map((tag: string) => (
                    <span class="px-2 py-0.5 text-xs rounded-full border border-stone-300 dark:border-stone-600 text-stone-600 dark:text-stone-400">
                      {tag}
                    </span>
                  ))}
                </div>
              )}
            </div>
            <p class="text-stone-600 dark:text-stone-400 mt-2">
              {post.data.description}
            </p>
          </a>
        </li>
      ))
    }
  </ul>

  {
    archivePosts.length > 0 && (
      <details class="mt-12 border-t border-stone-200 dark:border-stone-700 pt-6">
        <summary class="cursor-pointer select-none group">
          <span class="font-serif text-2xl font-bold group-hover:text-accent transition-colors">
            Archive
          </span>
          <span class="ml-2 text-sm text-stone-400 dark:text-stone-500">
            {archivePosts.length} older{" "}
            {archivePosts.length === 1 ? "post" : "posts"} â€” click to expand
          </span>
        </summary>
        <ul class="mt-6 divide-y divide-stone-200 dark:divide-stone-700">
          {archivePosts.map((post) => (
            <li class="py-6 first:pt-0">
              <a href={`/blog/${post.id}`} class="group block">
                <h2 class="text-xl font-semibold group-hover:text-accent transition-colors">
                  {post.data.title}
                  {post.data.draft && (
                    <span class="ml-2 align-middle text-xs font-medium px-1.5 py-0.5 rounded bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200">
                      Draft
                    </span>
                  )}
                </h2>
                <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-stone-500 mt-1">
                  <time datetime={post.data.date.toISOString()}>
                    {formatDate(post.data.date)}
                  </time>
                  {post.data.tags.length > 0 && (
                    <div class="flex gap-2">
                      {post.data.tags.map((tag: string) => (
                        <span class="px-2 py-0.5 text-xs rounded-full border border-stone-300 dark:border-stone-600 text-stone-600 dark:text-stone-400">
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
                <p class="text-stone-600 dark:text-stone-400 mt-2">
                  {post.data.description}
                </p>
              </a>
            </li>
          ))}
        </ul>
      </details>
    )
  }
</BaseLayout>
